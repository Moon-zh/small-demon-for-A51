CS1	EQU	P2.0	//16位数码管显示
CS2	EQU	P2.1
E	EQU	P2.2
DS18B20	EQU	P2.3
SMG	EQU	P0

DS0	EQU	30H
DS1	EQU	31H
DS2	EQU	32H
DS3	EQU	33H
DS4	EQU	34H
DS5	EQU	35H
DS6	EQU	36H
DS7	EQU	37H
DS8	EQU	38H
W1	EQU	39H
W2	EQU	3AH   
   
   
	ORG	00H
	AJMP	MAIN
	ORG	30H

MAIN:	MOV	SP,#80H
	MOV	R0,#DS0//数码管初始化
	MOV	B,#8
M1:	MOV	@R0,#0
	INC	R0
	DJNZ	B,M1

MAI:	LCALL	CS18B20	//18b20 初始化
	MOV	A,#33H	//读序列号命令
	LCALL	E18B20
	MOV	R1,#30H	//间接寻址存储序列号
	
	MOV	R7,#8	//64位序列号
M2:	LCALL	RD18B20	//读8位
	ANL	A,#0F0H	//屏蔽高位
	SWAP	A	//高低位交换
	MOV	@R1,A	//送入数码管显示值
	INC	R1
       	DJNZ	R7,M2
MI:	LCALL	MY	//数码管显示
	AJMP	MAI

CS18B20:CLR	DS18B20	//18b20 初始化
	MOV	R0,#240
	DJNZ	R0,$
	SETB	DS18B20
	MOV	R0,#30
	DJNZ	R0,$
	JNB	DS18B20,$
	MOV	R0,#250
	DJNZ	R0,$
	RET

E18B20:	MOV	B,#08H	//写数据
E1:	CLR	DS18B20
	RRC	A
	MOV	DS18B20,C
	MOV	R0,#28
	DJNZ	R0,$
	SETB	DS18B20
	DJNZ	B,E1
	RET

RD18B20:MOV	B,#08H	//读数据
RD1:	CLR	DS18B20
	MOV	R0,#1
	DJNZ	R0,$
	SETB	DS18B20
	MOV	C,DS18B20
	RRC	A
	MOV	R0,#23
	DJNZ	R0,$
	DJNZ	B,RD1
	RET

BI1:	LCALL	CS18B20	//初始化跳过读序列码
	MOV	A,#0CCH
	LCALL	E18B20
	RET

MY:	MOV	DPTR,#TAB	//数码管显示
	MOV	R1,#DS0
	MOV	R2,#0FEH
MA:	MOV	A,@R1
	MOVC	A,@A+DPTR
	MOV	SMG,A
	INC	R1
	CLR	E
	CLR	CS1
	SETB	E
	SETB	CS1
	MOV	A,R2
	MOV	SMG,A
	RL	A
	MOV	R2,A
	CLR	E
	CLR	CS2
	SETB	E
	SETB	CS2
	LCALL	SMYS
	LCALL	SMQP
	CJNE	R1,#38H,MA
	RET
	
SMYS:	MOV	R7,#0FFH
	DJNZ	R7,$
	RET

SMQP:	MOV	SMG,#0FFH
	CLR	E
	CLR	CS1
	SETB	E
	SETB	CS1
	CLR	E
	CLR	CS2
	SETB	E
	SETB	CS2
	RET

TAB:DB 0C0H,0F9H,0A4H,0B0H,99H,92H,82H,0F8H,80H,90H,0FFH
